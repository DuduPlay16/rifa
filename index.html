<!DOCTYPE html>
<html lang="pt">
<head>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
  // ====== FIREBASE CONFIG ======
  const firebaseConfig = {
    apiKey: "AIzaSyDtbPZOZSivOO441D9uCb-vyLkKUKAKWnQ",
    authDomain: "rifa-a438f.firebaseapp.com",
    projectId: "rifa-a438f",
    storageBucket: "rifa-a438f.firebasestorage.app",
    messagingSenderId: "42457719190",
    appId: "1:42457719190:web:02d3d9cc313df507fd7db7"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
</script>

<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Rifa dos m√∫sicos</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0b0f16;
    --panel:#0f1720;
    --neon1:#00f5ff;
    --neon2:#ff3ecf;
    --accent:#ffd166;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%}
  body{
    background: radial-gradient(circle at 10% 10%, rgba(2,6,23,1) 0%, rgba(8,11,18,1) 35%, rgba(6,7,11,1) 100%);
    font-family: "Inter",system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
    color:#fff; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    overflow:auto;
  }
  .bg-layer{ position:fixed; inset:0; z-index:0; pointer-events:none; overflow:hidden; }
  .bg-glow{ position:absolute; width:1600px; height:1600px; left:50%; top:-30%; transform:translateX(-50%); background: linear-gradient(135deg, rgba(0,245,255,0.08), rgba(255,62,207,0.06)); filter: blur(80px); opacity:0.9; }
  .suits { position:absolute; inset:0; z-index:0; pointer-events:none; }
  .suits .suit { position:absolute; font-size:80px; opacity:0.12; transform-origin:center; filter: drop-shadow(0 0 10px rgba(0,0,0,0.6)); animation: floatSuit linear infinite; will-change: transform, opacity; }
  @keyframes floatSuit { 0% { transform: translateY(0) rotate(0deg) scale(1); opacity:0.06; } 50% { transform: translateY(-60px) rotate(20deg) scale(1.05); opacity:0.12; } 100% { transform: translateY(0) rotate(0deg) scale(1); opacity:0.06; } }
  .cards { position:absolute; inset:0; z-index:0; pointer-events:none; }
  .card { position:absolute; width:140px; height:200px; border-radius:12px; background: linear-gradient(180deg,#ffffff 0%, #f0f0f0 100%); box-shadow: 0 20px 60px rgba(0,0,0,0.6); transform-origin:center; opacity:0.07; animation: floatCard linear infinite; }
  @keyframes floatCard { 0% { transform: translateY(0) rotate(0deg) scale(1); } 50% { transform: translateY(-40px) rotate(6deg) scale(1.02); opacity:0.12; } 100% { transform: translateY(0) rotate(0deg) scale(1); opacity:0.07; } }

  .app { position:relative; z-index:2; min-height:100vh; display:flex; align-items:center; justify-content:center; padding:28px 0; }
  .center { width:100%; max-width:1100px; margin:24px; display:flex; gap:24px; align-items:flex-start; max-height: calc(100vh - 120px); overflow:auto; padding:6px; }

  .panel { background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:14px; padding:26px; box-shadow: 0 8px 30px rgba(0,0,0,0.6), 0 0 18px rgba(0,0,0,0.6); border: 1px solid rgba(255,255,255,0.04); backdrop-filter: blur(6px) saturate(120%); }
  .splash { width:100%; height:100vh; display:flex; align-items:center; justify-content:center; flex-direction:column; text-align:center; padding:40px; z-index:2; }
  .title { font-family: "Orbitron", monospace; font-size:48px; letter-spacing:2px; text-transform:uppercase; color:var(--neon1); }
  .enterBtn { margin-top:28px; padding:20px 36px; font-size:22px; border-radius:999px; border:none; cursor:pointer; color:#04111e; font-weight:700; background:linear-gradient(90deg,var(--neon1),var(--neon2)); }
  .welcomeCard { width:100%; max-width:900px; margin:auto; text-align:center; padding:36px; border-radius:14px; }
  .leftCol { flex: 1; min-width:320px; max-width:520px; }
  .rightCol { flex: 1; min-width:320px; max-width:520px; }
  h1.appTitle{ font-family:Orbitron; color:var(--neon1); font-size:28px; }
  .box { background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:18px; border-radius:12px; margin-bottom:18px; border:1px solid rgba(255,255,255,0.03); }
  input[type="text"], input[type="number"]{ width:100%; padding:14px 12px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); background: rgba(255,255,255,0.02); color:#fff; font-size:16px; }
  button.btn { padding:12px 16px; font-size:16px; border-radius:10px; border:none; cursor:pointer; background: linear-gradient(180deg,var(--neon1),var(--neon2)); color:#021018; font-weight:700; margin:6px 6px 6px 0; }
  .credits { position:fixed; right:20px; bottom:18px; z-index:5; font-size:13px; color: #ffdede; }
  @media (max-width:900px){ .center{ flex-direction:column; align-items:stretch; max-height:none; overflow:visible } .card{ display:none } }
</style>
</head>
<body>

  <div class="bg-layer" aria-hidden="true">
    <div class="bg-glow"></div>
    <div class="suits" id="bgSuits">
      <div class="suit" style="color:rgba(0,245,255,0.06)">‚ô†</div>
      <div class="suit" style="color:rgba(255,62,207,0.06)">‚ô•</div>
      <div class="suit" style="color:rgba(255,245,120,0.06)">‚ô¶</div>
      <div class="suit" style="color:rgba(0,245,255,0.05)">‚ô£</div>
      <div class="suit" style="color:rgba(255,62,207,0.05)">‚ô†</div>
      <div class="suit" style="color:rgba(255,245,120,0.05)">‚ô•</div>
      <div class="suit" style="color:rgba(0,245,255,0.04)">‚ô¶</div>
      <div class="suit" style="color:rgba(255,62,207,0.04)">‚ô£</div>
    </div>
    <div class="cards">
      <div class="card"><div class="suitTiny">‚ô†</div></div>
      <div class="card"><div class="suitTiny">‚ô•</div></div>
      <div class="card"><div class="suitTiny">‚ô¶</div></div>
    </div>
  </div>

  <div class="app">

    <div id="splashScreen" class="splash">
      <div class="panel welcomeCard" style="max-width:900px;">
        <div style="display:flex; align-items:center; gap:18px; justify-content:center; flex-direction:column;">
          <div style="display:flex; align-items:center; gap:12px; justify-content:center;">
            <div style="font-size:44px; color:var(--neon1); transform:translateY(-6px)">üéµ</div>
            <div class="title">Rifa dos m√∫sicos</div>
            <div style="font-size:44px; color:var(--neon2); transform:translateY(-6px)">üÇ°</div>
          </div>
          <div class="subtitle">Sistema de rifa feito por DuduPlay, agora ninguem rouba ningue!</div>
          <button class="enterBtn" id="enterBtn">Entrar</button>
          <p style="margin-top:12px; font-size:13px; color:#dfefff; opacity:0.8">Feito por <b style="color:var(--neon2)">DuduPlay</b></p>
        </div>
      </div>
    </div>

    <div id="welcomeScreen" class="splash" style="display:none;">
      <div class="panel welcomeCard">
        <h2>Bem-vindo √† Rifa dos m√∫sicos!</h2>
        <p>Aqui voc√™ controla pontos, d√≠vidas e o valor das rifas. Visual neon, cartas e naipes animados para dar clima.</p>
        <button class="btn" id="toAppBtn">Entrar no sistema</button>
      </div>
    </div>

    <div id="roomScreen" class="splash" style="display:none;">
      <div class="panel welcomeCard" style="max-width:700px;">
        <h2>Sistema de Salas</h2>
        <h3 style="margin-top:18px;">Criar Sala</h3>
        <input id="newRoomName" placeholder="Nome da sala" style="margin-top:8px;">
        <input id="newRoomPass" placeholder="Senha da sala" type="password" style="margin-top:8px;">
        <button class="btn" style="margin-top:12px;" onclick="createRoom()">Criar Sala</button>

        <hr style="margin:25px 0; opacity:0.2;">

        <h3>Entrar em Sala</h3>
        <select id="roomList" style="margin-top:8px; width:100%; padding:12px;"></select>
        <input id="enterRoomPass" placeholder="Senha da sala" type="password" style="margin-top:8px;">
        <button class="btn" style="margin-top:12px;" onclick="enterRoom()">Entrar</button>
        <button class="btn danger" style="margin-top:12px; background:#8b0000;" onclick="deleteRoom()">Excluir Sala</button>
      </div>
    </div>

    <div id="mainApp" style="display:none; width:100%;">
      <div class="center">
        <div class="leftCol">
          <div class="panel box">
            <h1 class="appTitle">Sistema de Pontos e D√≠vidas</h1>

            <div style="margin-bottom:12px;">
              <label for="raffleValue" style="display:block; margin-bottom:6px; color:#dfefff">Valor da rifa</label>
              <input id="raffleValue" placeholder="Valor da rifa (ex: 10)" type="number" value="10">
            </div>

            <div style="margin-bottom:12px;">
              <label style="display:block; margin-bottom:6px; color:#dfefff">Jogadores (2 a 4)</label>
              <input id="p1" placeholder="Jogador 1">
              <input id="p2" placeholder="Jogador 2" style="margin-top:8px">
              <input id="p3" placeholder="Jogador 3 (opcional)" style="margin-top:8px">
              <input id="p4" placeholder="Jogador 4 (opcional)" style="margin-top:8px">
            </div>

            <div class="controlRow">
              <button class="btn" onclick="startGame()">Iniciar</button>
              <button class="btn" onclick="resetAll()" style="background:linear-gradient(90deg,#ff8a00,#ffd166)">Reiniciar Tudo</button>
            </div>
          </div>

          <div id="statsArea" class="panel box" style="display:none;">
            <h3 style="margin-bottom:8px">Estat√≠sticas</h3>
            <p><b>Valor da rifa:</b> R$ <span id="raffleValueDisplay">0</span></p>
            <p><b>Rifas fechadas:</b> <span id="closedRaffles">0</span></p>
            <div id="playerWins" class="statsList"></div>
          </div>
        </div>

        <div class="rightCol">
          <div id="gameArea" class="panel box" style="display:none;"></div>

          <div id="debtsArea" class="panel box" style="display:none;">
            <h3>D√≠vidas</h3>
            <div id="debts"></div>
          </div>

          <div id="historyArea" class="panel box" style="display:none;">
            <h3>Hist√≥rico das Partidas</h3>
            <div id="history"></div>
            <button class="btn" style="margin-top:8px;" onclick="clearHistory()">Limpar hist√≥rico</button>
          </div>
        </div>
      </div>
    </div>

  </div>

  <div class="credits">Feito por DuduPlay</div>

  <!-- CUSTOM MODAL (substitui alert/confirm/prompt) -->
  <div id="modalOverlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.65); backdrop-filter:blur(4px); z-index:9999; align-items:center; justify-content:center;">
    <div id="modalBox" style="background:#0f1720; padding:24px; border-radius:14px; width:90%; max-width:360px; border:1px solid rgba(255,255,255,0.1); box-shadow:0 0 18px rgba(0,0,0,0.6); text-align:center;">
        <h3 id="modalTitle" style="margin-bottom:12px; color:#00f5ff; font-family:Orbitron"></h3>
        <p id="modalMessage" style="margin-bottom:22px; color:#dfefff;"></p>
        <div id="modalInputContainer" style="display:none; margin-bottom:18px;">
           <input id="modalInput" type="password" placeholder="Digite aqui..." style="width:100%; padding:12px; border-radius:10px; border:1px solid rgba(255,255,255,0.2); background:rgba(255,255,255,0.04); color:white;">
        </div>
        <button id="modalCancel" style="padding:10px 18px; margin-right:10px; border:none; border-radius:8px; background:#444; color:white; cursor:pointer;">Cancelar</button>
        <button id="modalOk" style="padding:10px 18px; border:none; border-radius:8px; background:linear-gradient(90deg,#00f5ff,#ff3ecf); color:#021018; cursor:pointer; font-weight:700;">OK</button>
    </div>
  </div>

<script>
/* ------------------------
   Estado do jogo (mem√≥ria)
   ------------------------ */
let players = [];
let sequenceUsed = false;   // se sequ√™ncia j√° foi usada na partida atual
let fourUsed = false;       // se four j√° foi usada na partida atual
let history = {};           // { partidaNumber: [string, string, ...], ... }
let currentPartida = 1;     // n√∫mero da partida atual (hist√≥rico)
let points = {};            // { playerName: points }
let debts = {};             // { playerA: {playerB: valor, ...}, ... }
let wins = {};              // { playerName: wins }
let raffleValue = 10;
let rafflesClosed = 0;
let currentRoom = null;
let unsubscribe = null;
let hasWonThisRound = {}; // controla se o jogador j√° venceu nesta rodada

/* DOM refs */
const splash = document.getElementById('splashScreen');
const welcome = document.getElementById('welcomeScreen');
const mainApp = document.getElementById('mainApp');
const roomScreen = document.getElementById('roomScreen');

/* ------------------------
   CUSTOM MODAL HELPERS
   (async alert/confirm/prompt)
   ------------------------ */
function showModal(title, message, options={}) {
  return new Promise(resolve => {
    const overlay = document.getElementById('modalOverlay');
    const modalTitle = document.getElementById('modalTitle');
    const modalMessage = document.getElementById('modalMessage');
    const modalInputContainer = document.getElementById('modalInputContainer');
    const modalInput = document.getElementById('modalInput');
    const btnOk = document.getElementById('modalOk');
    const btnCancel = document.getElementById('modalCancel');

    modalTitle.textContent = title;
    modalMessage.textContent = message;
    if (options.input) {
      modalInputContainer.style.display = 'block';
      modalInput.value = options.default || '';
      setTimeout(()=> modalInput.focus(), 50);
    } else {
      modalInputContainer.style.display = 'none';
    }

    overlay.style.display = 'flex';

    const cleanup = () => {
      overlay.style.display = 'none';
      btnOk.onclick = null;
      btnCancel.onclick = null;
    };

    btnOk.onclick = () => {
      cleanup();
      resolve(options.input ? modalInput.value : true);
    };
    btnCancel.onclick = () => {
      cleanup();
      resolve(false);
    };
  });
}

function alertModal(msg){ return showModal('Aviso', msg); }
function confirmModal(msg){ return showModal('Confirmar', msg); }
function promptModal(msg, def=''){ return showModal('Entrada', msg, { input:true, default:def }); }

/* ------------------------
   UI / Eventos iniciais
   ------------------------ */
document.getElementById('enterBtn').addEventListener('click', () => {
  splash.style.display = 'none';
  welcome.style.display = 'flex';
});

document.getElementById('toAppBtn').addEventListener('click', async () => {
  welcome.style.display = 'none';
  roomScreen.style.display = 'flex';
  await loadRooms();
});

/* randomiza bg suits */
function randomizeBgSuits(){
  const suits = document.querySelectorAll('.suits .suit');
  suits.forEach((el) => {
    const x = Math.random()*85;
    const y = Math.random()*85;
    el.style.left = x + '%';
    el.style.top = y + '%';
    el.style.transform = `rotate(${Math.floor(Math.random()*30-15)}deg)`;
  });
}
randomizeBgSuits();
document.addEventListener('visibilitychange', randomizeBgSuits);

/* ------------------------
   RENDERERS
   ------------------------ */
function renderGame() {
  let html = `<h2>Pontuar Jogadores</h2>`;
  players.forEach(p => {
    const pts = points[p] || 0;
    html += `
      <div class="box" style="padding:14px;">
        <h3 style="margin-bottom:10px">${p} ‚Äî ${pts} pontos</h3>
        <div>
          <button class="btn" onclick="handleAction('${p}','seq')" ${sequenceUsed ? 'disabled' : ''}>Sequ√™ncia (1)</button>
          <button class="btn" onclick="handleAction('${p}','four')" ${fourUsed ? 'disabled' : ''}>Four (1)</button>
          <button class="btn" onclick="handleAction('${p}','bat9')">Batida 9 (1)</button>
          <button class="btn" onclick="handleAction('${p}','bat10')">Batida 10 (2)</button>
          <button class="btn" style="background:linear-gradient(90deg,#ff3e3e,#ff8a8a)" onclick="removerPontos('${p}',1)">Remover 1 ponto</button>
          <button class="btn" style="background:linear-gradient(90deg,#ff3e3e,#ff8a8a)" onclick="removerPontos('${p}',2)">Remover 2 ponto</button>
        </div>
      </div>
    `;
  });
  document.getElementById("gameArea").innerHTML = html;
}

function renderDebts() {
  let html = "";
  players.forEach(a => {
    html += `<h3 style="margin-bottom:6px">${a} deve:</h3>`;
    players.forEach(b => {
      if (a !== b) {
        const v = debts[a] && debts[a][b] ? debts[a][b] : 0;
        html += `<p>${b}: <b>R$ ${v}</b></p>`;
      }
    });
    html += "<br>";
  });
  document.getElementById("debts").innerHTML = html;
}

function renderStats() {
  document.getElementById("closedRaffles").innerText = rafflesClosed;
  let html = "<h4>Vit√≥rias dos jogadores:</h4>";
  players.forEach(p => {
    html += `<p style="margin:4px 0">${p}: <b>${wins[p] || 0} vit√≥ria(s)</b></p>`;
  });
  document.getElementById("playerWins").innerHTML = html;
}

function renderHistory(){
  let html = '';
  // percorre partidas existentes na ordem
  const keys = Object.keys(history).map(n=>Number(n)).sort((a,b)=>a-b);
  keys.forEach(k => {
    const arr = history[k] || [];
    html += `<h4>Partida ${k}</h4>`;
    if(arr.length === 0) html += `<p style="margin:4px 0; opacity:0.7">‚Äî sem a√ß√µes ‚Äî</p>`;
    else html += arr.map(h => `<p style="margin:4px 0">${h}</p>`).join('');
    html += '<hr style="opacity:0.2; margin:8px 0">';
  });
  document.getElementById('history').innerHTML = html;
}

/* ------------------------
   JOGO: iniciar / reset
   ------------------------ */
async function startGame(){
  // pega jogadores
  players = [p1.value, p2.value, p3.value, p4.value].filter(n => n && n.trim() !== "").map(n => n.trim());

  if (players.length < 2) {
    await alertModal('Coloque pelo menos 2 jogadores.');
    return;
  }

  // reset flags e estruturas
  sequenceUsed = false;
  fourUsed = false;
  history = {};
  currentPartida = 1;
  history[currentPartida] = [];

  points = {};
  debts = {};
  wins = {};
  rafflesClosed = 0;
  hasWonThisRound = {};

  raffleValue = Number(document.getElementById("raffleValue").value) || 10;
  document.getElementById("raffleValueDisplay").innerText = raffleValue;

  // inicializa pontos, d√≠vidas, vit√≥rias e flags
  players.forEach(a => {
    points[a] = 0;
    wins[a] = 0;
    debts[a] = {};
    hasWonThisRound[a] = false;
    players.forEach(b => debts[a][b] = 0);
  });

  renderGame(); renderDebts(); renderStats(); renderHistory();

  document.getElementById("gameArea").style.display = "block";
  document.getElementById("debtsArea").style.display = "block";
  document.getElementById("statsArea").style.display = "block";
  document.getElementById("historyArea").style.display = "block";

  saveRoomState();
}

async function resetAll(){
  const ok = await confirmModal('Reiniciar tudo? Isso apagar√° jogadores, d√≠vidas e estat√≠sticas.');
  if(!ok) return;
  players = []; sequenceUsed = false; fourUsed = false; history = {}; currentPartida = 1;
  points = {}; debts = {}; wins = {}; raffleValue = 10; rafflesClosed = 0;
  document.getElementById('raffleValue').value = 10;
  document.getElementById('raffleValueDisplay').innerText = 0;
  document.getElementById('gameArea').style.display = "none";
  document.getElementById('debtsArea').style.display = "none";
  document.getElementById('statsArea').style.display = "none";
  document.getElementById('historyArea').style.display = "none";
  // volta para sele√ß√£o de salas
  mainApp.style.display = 'none';
  roomScreen.style.display = 'flex';
  await saveRoomState();
}

/* remover pontos */
function removerPontos(player, value) {
  if (points[player] !== undefined) {
    points[player] -= value;
    if (points[player] < 0) points[player] = 0;
    renderGame(); renderDebts(); renderStats(); renderHistory();
    saveRoomState();
  }
}

/* ------------------------
   A√á√ïES (sequ√™ncia/four/bat9/bat10)
   - regra: seq/four s√≥ 1x por partida
   - bat9/10 encerra a partida atual (hist√≥rico), cria pr√≥xima partida,
     mas N√ÉO zera os pontos (pontos acumulam across partidas).
   - processWin (>=10 pontos) aplica d√≠vidas e zera pontos.
   ------------------------ */
async function handleAction(player, action){
  if(!players.includes(player)) return;

  // VERIFICA√á√ÉO IMEDIATA: se j√° atingiu 10 antes de qualquer a√ß√£o
  if(points[player] >= 10 && !hasWonThisRound[player]){
    hasWonThisRound[player] = true;
    ensureHistory(currentPartida);
    history[currentPartida].push(`${player} atingiu 10+ pontos`);
    await processWin(player);
    return;
  }

  if(action === 'seq'){
    if(sequenceUsed) {
      await alertModal('Sequ√™ncia j√° foi feita nesta partida!');
      return;
    }
    sequenceUsed = true;
    ensureHistory(currentPartida);
    history[currentPartida].push(`${player} fez SEQU√äNCIA`);
    points[player] = (points[player] || 0) + 1;
  }
  else if(action === 'four'){
    if(fourUsed){
      await alertModal('Four j√° foi feito nesta partida!');
      return;
    }
    fourUsed = true;
    ensureHistory(currentPartida);
    history[currentPartida].push(`${player} fez FOUR`);
    points[player] = (points[player] || 0) + 1;
  }
  else if(action === 'bat9'){
    ensureHistory(currentPartida);
    history[currentPartida].push(`${player} bateu com 9`);
    points[player] = (points[player] || 0) + 1;
  }
  else if(action === 'bat10'){
    ensureHistory(currentPartida);
    history[currentPartida].push(`${player} bateu com 10`);
    points[player] = (points[player] || 0) + 2;
  }

  // AP√ìS QUALQUER A√á√ÉO: verificar vit√≥ria
  if(points[player] >= 10 && !hasWonThisRound[player]){
    hasWonThisRound[player] = true;
    ensureHistory(currentPartida);
    history[currentPartida].push(`${player} atingiu 10+ pontos`);
    await processWin(player);
    return;
  }

  // encerra rodada por batida normal
  if(action === 'bat9' || action === 'bat10') await endRound(player, 'batida');

  renderGame(); renderDebts(); renderStats(); renderHistory();
  saveRoomState();
}

/* garante que history[number] exista */
function ensureHistory(n){
  if(!history[n]) history[n] = [];
}

/* encerra a partida atual (ex: por batida), cria pr√≥xima partida no hist√≥rico */
async function endRound(player, reason = 'batida'){
  ensureHistory(currentPartida);
  history[currentPartida].push(`${player} encerrou a partida (${reason})`);
  // iniciar pr√≥xima partida no hist√≥rico
  currentPartida++;
  history[currentPartida] = [];
  // reset flags seq/four para a nova partida
  sequenceUsed = false;
  fourUsed = false;
  history[currentPartida].push('--- nova partida ---');

  renderGame(); renderDebts(); renderStats(); renderHistory();
  saveRoomState();
}

/* processWin: quando jogador >=10 pontos -> aplicar d√≠vidas e zerar pontos */
async function processWin(winner){
  // marca vit√≥ria
  wins[winner] = (wins[winner] || 0) + 1;
  rafflesClosed++;

  ensureHistory(currentPartida);
  history[currentPartida].push(`${winner} venceu por acumular 10 ou mais pontos!`);

  // aplicar d√≠vidas entre players
  players.forEach(other => {
    if(other === winner) return;

    if(!debts[other]) debts[other] = {};
    if(!debts[winner]) debts[winner] = {};

    const valor = raffleValue;

    const deveParaWinner = debts[other][winner] || 0;
    const winnerDeveParaOther = debts[winner][other] || 0;

    if(winnerDeveParaOther > 0){
      // primeiro compensar d√≠vidas do vencedor
      const compensa = Math.min(valor, winnerDeveParaOther);
      debts[winner][other] -= compensa;
      const restante = valor - compensa;
      if(restante > 0) debts[other][winner] = (debts[other][winner] || 0) + restante;
    } else {
      // cria d√≠vida normal
      debts[other][winner] = (debts[other][winner] || 0) + valor;
    }
  });

  // reset pontos do vencedor apenas
  points[winner] = 0;

  // iniciar nova partida no hist√≥rico
  currentPartida++;
  history[currentPartida] = [];
  history[currentPartida].push('--- nova partida ---');

  // reset flags
  sequenceUsed = false;
  fourUsed = false;

  renderGame(); renderDebts(); renderStats(); renderHistory();
  await alertModal(`${winner} ganhou a rifa!`);
  saveRoomState();
}

/* limpar hist√≥rico */
async function clearHistory(){
  const ok = await confirmModal('Limpar hist√≥rico desta sala?');
  if(!ok) return;
  history = {};
  currentPartida = 1;
  history[currentPartida] = [];
  saveRoomState();
  renderHistory();
}

/* ------------------------
   FIRESTORE: salas / estado
   ------------------------ */
async function loadRooms(){
  try{
    const sel = document.getElementById('roomList');
    sel.innerHTML = '';
    const snap = await db.collection('rooms').get();
    if(snap.empty){
      sel.innerHTML = '<option>Nenhuma sala criada</option>';
      return;
    }
    snap.forEach(doc => {
      const opt = document.createElement('option');
      opt.value = doc.id;
      opt.textContent = doc.id;
      sel.appendChild(opt);
    });
  }catch(e){
    console.error('Erro ao carregar salas:', e);
    await alertModal('Erro ao carregar salas: ' + (e.message || e));
  }
}

async function createRoom(){
  try{
    const name = (document.getElementById('newRoomName').value || '').trim();
    const pass = (document.getElementById('newRoomPass').value || '').trim();
    if(!name || !pass) {
      await alertModal('Preencha nome e senha!');
      return;
    }
    await db.collection('rooms').doc(name).set({ pass, state: null });
    await alertModal('Sala criada!');
    await loadRooms();
  }catch(e){
    console.error('createRoom error', e);
    await alertModal('Erro ao criar sala: ' + (e.message || e));
  }
}

async function enterRoom(){
  try{
    const name = (document.getElementById('roomList').value || '').trim();
    const pass = (document.getElementById('enterRoomPass').value || '').trim();
    if(!name){ await alertModal('Selecione uma sala'); return; }
    const ref = db.collection('rooms').doc(name);
    const docSnap = await ref.get();
    if(!docSnap.exists) { await alertModal('Sala n√£o encontrada'); return; }
    if(docSnap.data().pass !== pass){ await alertModal('Senha incorreta'); return; }

    currentRoom = name;

    // remove listener anterior
    if(unsubscribe) unsubscribe();

    // cria listener em tempo real
    unsubscribe = ref.onSnapshot(doc => {
      const data = doc.data();
      if(!data || !data.state) return;
      loadRoomStateLive(data.state);
    });

    // carrega estado atual (uma vez)
    if(docSnap.data().state) loadRoomStateLive(docSnap.data().state);

    roomScreen.style.display = 'none';
    mainApp.style.display = 'block';
  }catch(e){
    console.error('enterRoom error', e);
    await alertModal('Erro ao entrar na sala: ' + (e.message || e));
  }
}

function saveRoomState(){
  if(!currentRoom) return;
  const data = {
    sequenceUsed,
    fourUsed,
    history,
    currentPartida,
    players,
    points,
    debts,
    wins,
    raffleValue,
    rafflesClosed
  };
  db.collection('rooms').doc(currentRoom).update({ state: data }).catch(err=>{
    // se documento n√£o tiver sido criado por set antes, usar set()
    if(err && /not-found|No document/i.test(err.message || '')){
      db.collection('rooms').doc(currentRoom).set({ pass: '', state: data }).catch(e=>console.error('save fallback failed', e));
    } else {
      console.error('saveRoomState error', err);
    }
  });
}

function loadRoomStateLive(state){
  // state pode estar incompleto ‚Äî usamos defaults
  sequenceUsed = state.sequenceUsed || false;
  fourUsed = state.fourUsed || false;
  history = state.history || {};
  currentPartida = state.currentPartida || 1;
  // players & maps
  players = state.players || players || [];
  points = state.points || state.points || {};
  debts = state.debts || state.debts || {};
  wins = state.wins || state.wins || {};
  raffleValue = state.raffleValue || raffleValue;
  rafflesClosed = state.rafflesClosed || rafflesClosed;

  document.getElementById("raffleValueDisplay").innerText = raffleValue;
  renderGame(); renderDebts(); renderStats(); renderHistory();

  document.getElementById("gameArea").style.display = "block";
  document.getElementById("debtsArea").style.display = "block";
  document.getElementById("statsArea").style.display = "block";
  document.getElementById("historyArea").style.display = "block";
}

async function deleteRoom(){
  try{
    const name = (document.getElementById('roomList').value || '').trim();
    if(!name){ await alertModal('Nenhuma sala selecionada'); return; }
    const pass = await promptModal('Digite a senha da sala para excluir:');
    if(!pass){ await alertModal('Senha n√£o informada!'); return; }
    const ref = db.collection('rooms').doc(name);
    const snap = await ref.get();
    if(!snap.exists){ await alertModal('Sala n√£o encontrada'); return; }
    if(snap.data().pass !== pass){ await alertModal('Senha incorreta!'); return; }
    const ok = await confirmModal(`Excluir a sala "${name}"?`);
    if(!ok) return;
    await ref.delete();
    await alertModal('Sala exclu√≠da!');
    await loadRooms();
  }catch(e){
    console.error('deleteRoom error', e);
    await alertModal('Erro ao excluir sala: ' + (e.message || e));
  }
}

/* ------------------------
   UTIL
   ------------------------ */
function flashWinner(name){ const bg = document.querySelector('.bg-glow'); if(!bg) return; bg.animate([{filter:'blur(80px) brightness(1)', opacity:0.9},{filter:'blur(40px) brightness(1.6)', opacity:1},{filter:'blur(80px) brightness(1)', opacity:0.9}],{duration:700,easing:'ease-out'}); }

</script>
</body>
</html>
